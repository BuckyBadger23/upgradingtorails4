## Upgrading to Rails 4

Since the advent of [Bundler](http://gembundler.com), upgrading a Rails
application has become much easier.

That said, upgrading to Rails 4 is a bit more involved than simply running
`bundle update`.

---

### <a id="rails-32"></a>Rails 3.2

It is much easier to upgrade a Rails application in small steps. If an
application you wish to upgrade to Rails 4 is not yet running the latest
version of Rails 3.2, you should first upgrade it there as a stepping stone.

In order to provide the best content in a concise form, this handbook assumes
applications being upgraded are running on the latest version of Rails 3.2.

Resources that can help upgrade older applications to Rails 3 include:

* [Rails 3 Upgrade Handbook](http://www.railsupgradehandbook.com/)
* [Rails 3.2 Release Notes](http://guides.rubyonrails.org/3_2_release_notes.html)

### <a id="ruby-193"></a>Ruby 1.9.3

Rails 4 *requires* Ruby 1.9.3 and *recommends* Ruby 2.0.0. Attempting to run
Rails 4 with a Ruby version below 1.9.3 will cause syntax errors or runtime
issues.

While Ruby 2.0.0 is mostly backwards compatible with 1.9.3, I recommend you
upgrade only to 1.9.3 during the initial stages of upgrading to Rails 4. You
are less likely to run into issues with Ruby itself if the jump is as small as
possible. After you have stabilized your application on Ruby 1.9.3 and Rails
4, consider upgrading to Ruby 2.0.0.

You can upgrade Ruby with a single command using [`rvm`](https://rvm.io/):

@@@ text
$ rvm install 1.9.3
@@@

If an existing application has a `.rvmrc` file in its root directory, it must
specify Ruby 1.9.3 or above. A new `.rvmrc` file can be generated by running:

@@@ text
$ rvm use --rvmrc 1.9.3
@@@

If an existing application uses [JRuby](http://jruby.org), Rails 4 requires
version JRuby 1.7.0 or above (which runs with Ruby 1.9.3 support by default).
Unfortunately, JRuby version numbers are a tad confusing.

@@@ text
$ rvm install jruby-1.7.3
$ rvm use --rvmrc jruby-1.7.3
@@@

### <a id="bundler"></a>bundler

It is possible that Rails 4 will require a more recent version of `bundler`
than is installed in your set of gems.

To avoid any potential problems, simply upgrade to the latest version of
`bundler` before going any farther:

@@@ text
$ gem install bundler
@@@

### <a id="rails4_upgrade"></a>rails4\_upgrade gem

The [`rails4_upgrade gem`](https://github.com/alindeman/rails4_upgrade) helps
automate some of the process required to upgrade to Rails 4.

Install the gem in the application that's being upgraded by adding it to
`Gemfile`:

@@@ ruby
# Gemfile
gem 'rails4_upgrade'
@@@

Finish the installation by running `bundle`:

@@@ text
$ bundle install
@@@

### <a id="incompatible-gems"></a>Checking for Incompatible Gems

`rails4_upgrade` adds a `rake` task to check for gems that are locked to
Rails 3, preventing an application from upgrading successfully.

Run the task:

@@@ text
$ bundle exec rake rails4:check_gems
@@@

In an ideal world, you would see `"No gem incompatibilities found"`, meaning
you can upgrade to Rails 4 straightaway. However, it is more likely that you
will be presented with a table of gems and the version of Rails to which they
are locked.

In this example, the application depends on a version of
[`draper`](http://github.com/drapergem/draper) that requires `actionpack` 3.2.x
and `activesupport` 3.2.x, both gems in the Rails suite:

@@@ text
+-----------------+----------------------+
| Dependency Path | Rails Requirement    |
+-----------------+----------------------+
| draper 0.18.0   | actionpack ~> 3.2    |
| draper 0.18.0   | activesupport ~> 3.2 |
+-----------------+----------------------+
@@@

Attempting to upgrade to Rails 4 with `draper` 0.18.0 will cause `bundler` to
raise an error, as this would violate the constraint set by draper.

If an incompatible gem in the list is under active development, it may already
have a version that supports Rails 4. Check the gem's website or source
repository (often hosted on [GitHub](http://github.com)).

If a Rails 4 compatible version is available, specify the compatible version in
`Gemfile` and use `bundler` to update it. In this case, `draper` 1.0.0 supports
Rails 4.

@@@ ruby
# Gemfile
gem 'draper', '>=1.0.0'
@@@

<p></p>

@@@ text
$ bundle update draper
@@@

If a Rails 4 compatible version is not yet available, it is unfortunately not
possible for you to upgrade until that gem adds support or the gem is removed
from the application.

Check the gem's issue tracker to see if the authors are aware of the
incompatibility; if not, create a new issue.

It is also possible that the gem already works with Rails 4 and the constraints
that the gem authors impose are simply unnecessary. Flip to the appendix on
[forking the gem source and loosening the
constraints](#forking-and-loosening-constraints) to see if it is possible to
loosen the constraints manually for the time being.

While it may start feeling like a game of whack-a-mole, repeat the process
until `rake rails4:check_gems` reports that no incompatibilities exist.

### <a id="upgrading-rails-itself"></a>Upgrading Rails Itself

Open `Gemfile` in a text editor and change the line that starts with `gem
'rails'` to:

@@@ ruby
# Gemfile
gem 'rails', '~>4.0.0.beta1'
@@@

Rails 4 also depends on newer versions of gems that drive the asset pipeline
(which was introduced in Rails 3.1). Namely, make sure to update `sass-rails`
and `coffee-rails` as well:

@@@ ruby
# Gemfile

group :assets do
  # Replaces "gem 'sass-rails', '~>3.x.y'"
  gem 'sass-rails', '~>4.0.0.beta1'

  # Replaces "gem 'coffee-rails', '~>3.x.y'"
  gem 'coffee-rails', '~>4.0.0.beta1'
end
@@@

<!-- TODO: Table of gems to the feature that required them -->
<a id="deprecation-gems"></a>Finally, Rails 4 moves many features into gems
that were previously shipped with Rails itself. Later chapters go into more
detail about these changes. For now, however, add all of the gems that are
required to keep existing Rails features working properly after upgrading:

@@@ ruby
# Gemfile
gem 'protected_attributes'
gem 'activeresource', github: 'rails/activeresource'
gem 'actionpack-action_caching', github: 'rails/actionpack-action_caching'
gem 'actionpack-page_caching', github: 'rails/actionpack-page_caching'
gem 'activerecord-session_store'
gem 'rails-observers'
gem 'actionview-encoded_mail_to'
gem 'rails-perftest'
gem 'actionpack-xml_parser', github: 'rails/actionpack-xml_parser'
@@@

Save `Gemfile` and run from the terminal:

@@@ text
$ bundle update rails
@@@

`bundle` should show output like:

@@@ text
Fetching gem metadata from https://rubygems.org/........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
...
@@@

You're riding on Rails 4!

### <a id="binstubs"></a>Binstubs

Rails 4 solidifies the idea that binaries are part of your application and
should be shipped alongside it.

Binaries have been a source of confusion in the Rails ecosystem for a while.
For instance, in Rails 3, the `rails` command can be run alone (just `rails`)
or via `script/rails`. It can also be run prefixed with `bundle exec`, though
it is normally not necessary.

On the other hand, the `rake` command usually *does* need to be prefixed with
`bundle exec` (gems like
[rubygems-bundler](https://github.com/mpapis/rubygems-bundler) remove the need
to actually type `bundle exec`, but the effect is simply hidden from view). If
you've ever been frustrated by a message claiming "You have already activated
rake x.y.z" you know what I mean!

There is another lesser-known option: binstubs. By running `bundle install
--binstubs` (instead of just `bundle install`), bundler populates the `bin/`
directory--local to the project--with binaries like `rake` that are guaranteed
to run the correct version specified by your application.

If you had run `bundle install --binstubs` in Rails 3, for instance, you could
correctly run binaries by using `bin/rails` and `bin/rake` instead of `rails`
and `rake`, respectively.

New Rails 4 applications standardize on this practice by automatically
generating `bin/rails` and `bin/rake`. You can generate binstubs for other
commands you often use too (e.g., `rspec`). Furthermore, you are encouraged to
check these binstubs into version control so that commands run consistently on
every machine the codebase is deployed to.

When upgrading, you might want to consider adopting this convention. To do so,
first remove `/bin` from `.gitignore` (if it's currently ignored) so you will
be able to add binstubs to version control.

Next, run `bundle exec rake rails:update:bin` to add the `bin/rails` and
`bin/rake` binstubs (this is the last time you'll need to use `bundle exec
rake`; now use `bin/rake` instead!).

Adding binstubs for other commands you frequently use is accomplished with the
`bundle binstubs` command. For instance, `bundle binstubs rspec-core` adds the
`bin/rspec` command (the `rspec` binary is a part of the `rspec-core` gem).

Finally, add these binstubs (and `.gitignore`) to version control:

@@@ text
$ git add .gitignore bin/
$ git commit -m 'Adds binstubs for rails and rake'
@@@

<!-- TODO: What happens if you were already using binstubs? -->
